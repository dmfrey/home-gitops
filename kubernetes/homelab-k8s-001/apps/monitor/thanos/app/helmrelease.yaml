---
# yaml-language-server: $schema=https://kubernetes-schemas.dmfrey.com/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: thanos

spec:

  interval: 15m

  chart:
    spec:
      chart: thanos
      version: 1.19.1
      sourceRef:
        kind: HelmRepository
        name: stevehipwell
        namespace: flux-system

  install:
    remediation:
      retries: 3

  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3

  uninstall:
    keepHistory: false

  # valuesFrom:
  #   - targetPath: objstoreConfig.config.bucket
  #     kind: ConfigMap
  #     name: thanos-ceph-bucket
  #     valuesKey: BUCKET_NAME
  #   - targetPath: objstoreConfig.config.endpoint
  #     kind: ConfigMap
  #     name: thanos-ceph-bucket
  #     valuesKey: BUCKET_HOST
  #   - targetPath: objstoreConfig.config.region
  #     kind: ConfigMap
  #     name: thanos-ceph-bucket
  #     valuesKey: BUCKET_REGION
  #   - targetPath: objstoreConfig.config.access_key
  #     kind: Secret
  #     name: thanos-ceph-bucket
  #     valuesKey: AWS_ACCESS_KEY_ID
  #   - targetPath: objstoreConfig.config.secret_key
  #     kind: Secret
  #     name: thanos-ceph-bucket
  #     valuesKey: AWS_SECRET_ACCESS_KEY

  values:

    commonAnnotations:
      secret.reloader.stakater.com/reload: thanos-secret

    objstoreConfig:
      # type: s3
      # config:
      #   insecure: true
      create: false
      name: thanos-secret
      key: objstore.yml

    serviceMonitor:
      enabled: true

    logLevel: debug

    compact:
      enabled: true

      extraArgs:
        - --compact.concurrency=4
        - --delete-delay=30m
      # networkPolicy: *networkPolicy
      # retentionResolutionRaw: 14d
      # retentionResolution5m: 14d
      # retentionResolution1h: 30d

      resources:
        requests:
          cpu: 15m
          memory: 204M
        # limits:
        #   memory: 270M

      persistence:
        enabled: true
        storageClass: "ceph-block"
        size: 15Gi

    query:
      enabled: true

      # dnsDiscovery:
      #   sidecarsService: kube-prometheus-stack-thanos-discovery
      #   sidecarsNamespace: monitor
      # networkPolicy: *networkPolicy

      replicas: 1

      replicaLabel:
        - "__replica__" # must match with kube-prometheus-stack value `.prometheus.prometheusSpec.replicaExternalLabelName`

      resources:
        requests:
          cpu: 15m
          memory: 64M
        # limits:
        #   memory: 99M

      # stores:
      #   - thanos-store-gateway-headless:10901

    queryFrontend:
      enabled: false

      ingress:
        enabled: true

        ingressClassName: internal

        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-prod
          hajimari.io/enable: "true"
          hajimari.io/icon: "mdi:alpha-t-box"
          external-dns.alpha.kubernetes.io/target: internal.${SECRET_DOMAIN}

        hosts:
          - &host thanos.${SECRET_DOMAIN}

        tls:
          - hosts:
            - *host
            secretName: thanos-tls-internal

    receive:
      enabled: true

      persistence:
        enabled: true
        storageClass: "ceph-block"
        size: 24Gi

      # resourcesPreset: "medium"

    rule:
      enabled: true

      # Breaks metrics that have cluster label due to conflict with cnpg
      # clusterName: ${CLUSTER_NAME} # must match with kube-prometheus-stack value `.prometheus.prometheusSpec.externalLabels.cluster`

      # replicaLabel: __replica__
      replicas: 1

      # config: |-
      #   groups:
      #     - name: PrometheusWatcher
      #       rules:
      #         - alert: PrometheusDown
      #           annotations:
      #             summary: A Prometheus has disappeared from Prometheus target discovery
      #           expr: absent(up{job="kube-prometheus-stack-prometheus"})
      #           for: 5m
      #           labels:
      #             severity: critical

      persistence:
        enabled: true
        storageClass: "ceph-block"
        size: 10Gi

      resources:
        requests:
          cpu: 23m
          memory: 94M
        limits:
          memory: 113M

      # alertmanagersConfig:
      #   create: true
      #   name: thanos-rule-alertmanagerconfigs
      #   value: |-
      #     alertmanagers:
      #       - http_config:
      #           proxy_url: alert-manager.monitor.svc.cluster.local:9093

    storeGateway:
      enabled: false

      replicas: 1

      # config:
      #   type: REDIS
      #   config:
      #     addr: "thanos-dragonfly-cluster.monitor.svc.cluster.local:6379"

      # containerPorts:
      #   http: 10902
      #   grpc: 10901

      # livenessProbe:
      #   initialDelaySeconds: 30
      # readinessProbe:
      #   initialDelaySeconds: 30

      resources:
        requests:
          cpu: 1
          memory: 2048M
        limits:
          memory: 4096M

      persistence:
        enabled: true
        storageClass: "ceph-block"
        size: 10Gi
