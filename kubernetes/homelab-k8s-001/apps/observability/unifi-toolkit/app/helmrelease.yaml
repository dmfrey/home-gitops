---
# yaml-language-server: $schema=https://kubernetes-schemas.dmfrey.com/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: unifi-toolkit
spec:

  chartRef:
    kind: OCIRepository
    name: unifi-toolkit

  interval: 1h

  values:

    controllers:
      unifi-toolkit:

        containers:
          app:
            image:
              repository: ghcr.io/crosstalk-solutions/unifi-toolkit
              tag: 1.8

            env:
              TZ: America/New_York

              # Core settings (loaded from .env)
              ENCRYPTION_KEY: 
              LOG_LEVEL: DEBUG
              DATABASE_URL: sqlite+aiosqlite:///./data/unifi_toolkit.db

              # Deployment settings
              DEPLOYMENT_TYPE: local
              AUTH_USERNAME: admin
              AUTH_PASSWORD_HASH:

              # UniFi settings (optional)
              # Set in External Secret
              UNIFI_VERIFY_SSL: false

              # Tool settings
              STALKER_REFRESH_INTERVAL: 60

            envFrom:
              - secretRef:
                  name: "{{ .Release.Name }}-secret"

            # probes:
            #   liveness: &probes
            #     enabled: true
            #     custom: true
            #     spec:
            #       httpGet:
            #         path: /health
            #         port: &port 80
            #       initialDelaySeconds: 0
            #       periodSeconds: 10
            #       timeoutSeconds: 1
            #       failureThreshold: 3
            #   readiness: *probes

            # resources:
            #   requests:
            #     cpu: 10m
            #   limits:
            #     memory: 128Mi

            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: {drop: ["ALL"]}

    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000

    service:
      app:
        ports:
          http:
            port: 8000

    route:
      app:
        hostnames:
          - "{{ .Release.Name }}.dmfrey.com"
        parentRefs:
          - name: envoy-internal
            namespace: network

    persistence:
      data:
        existingClaim: "{{ .Release.Name }}"
        globalMounts:
          - path: /app/data

      # env:
      #   type: secret
      #   name: "{{ .Release.Name }}-secret"
      #   globalMounts:
      #     - path: /app/.env
      #       subPath: .env
