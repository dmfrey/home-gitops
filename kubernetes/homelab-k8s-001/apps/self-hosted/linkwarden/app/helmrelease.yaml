---
# yaml-language-server: $schema=https://kubernetes-schemas.dmfrey.com/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app linkwarden

spec:

  interval: 1h

  chartRef:
    kind: OCIRepository
    name: app-template

  maxHistory: 2

  install:
    createNamespace: true
    remediation:
      retries: -1

  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3

  uninstall:
    keepHistory: false

  driftDetection:
    mode: enabled

  values:

    controllers:

      *app :
        type: statefulset

        annotations:
          reloader.stakater.com/auto: "true"

        containers:
          *app :
            image:
              repository: ghcr.io/linkwarden/linkwarden
              tag: v2.11.2@sha256:ecf4f27b03741971cb8d68d25b4a772418d6ddf40947bdfbb8f9cda53a1faba2

            # command: ["sh", "-c", "prisma migrate deploy && node seed.js && node server.js"]

            env:
              TZ: America/New_York
              NODE_ENV: production

              NEXT_PUBLIC_AUTHENTIK_ENABLED: true
              NEXT_PUBLIC_DISABLE_REGISTRATION: true
              NEXT_PUBLIC_CREDENTIALS_ENABLED: false
              AUTHENTIK_ISSUER: https://auth.dmfrey.com/application/o/linkwarden
              # AUTHENTIK_CLIENT_ID: set in externalsecret
              # AUTHENTIK_CLIENT_SECRET: set in externalsecret

              DATABASE_URL:
                valueFrom:
                  secretKeyRef:
                    name: pg-linkwarden-app
                    key: uri

              NEXT_PUBLIC_OLLAMA_ENDPOINT_URL: http://ollama.ai.svc.cluster.local:11434
              OLLAMA_MODEL: llama3.2

              NEXT_PUBLIC_EMAIL_PROVIDER: true
              EMAIL_FROM: bookmarks@dmfrey.com
              EMAIL_SERVER: smtp://smtp-relay.kube-system.svc.cluster.local:2525

            envFrom:
              - secretRef:
                  name: linkwarden-secret

            # resources:
            #   requests:
            #     memory: 350Mi
            #     cpu: 100m
            #   limits:
            #     memory: 1024Mi

    defaultPodOptions:
      securityContext:
        runAsNonRoot: false
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0
        fsGroupChangePolicy: OnRootMismatch

    service:
      *app :
        controller: *app
        ports:
          http:
            port: &port 3000

    route:
      *app :
        hostnames:
          - bookmarks.dmfrey.com
        annotations:
          gethomepage.dev/enabled: "true"
          gethomepage.dev/group: Tools
          gethomepage.dev/name: Linkwarden Bookmarks
          gethomepage.dev/icon: linkwarden.png
          gethomepage.dev/description: Bookmarks
        parentRefs:
          - name: external
            namespace: kube-system
            sectionName: https
        rules:
          - backendRefs:
              - name: *app
                port: *port

    persistence:
      data:
        existingClaim: ${VOLSYNC_CLAIM}
        advancedMounts:
          *app :
            *app :
              - path: /data
                readOnly: false

      tmp:
        type: emptyDir
        medium: Memory
