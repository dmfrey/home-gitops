---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: spring-cloud-dataflow
  namespace: dataflow
spec:
  interval: 30m
  chart:
    spec:
      chart: spring-cloud-dataflow
      version: 25.1.3
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
      interval: 30m
  values:

    server:

      configuration:
        metricsDashboard: grafana.monitor.svc.cluster.local:80

      resources:
        limits:
          cpu: "1"
          memory: 1024M
        requests:
          cpu: "1"
          memory: 1024M

      service:
        type: LoadBalancer
        port: 8080

      ingress:
        enabled: true

        annotations:
          nginx.org/websocket-services: dataflow
          cert-manager.io/cluster-issuer: letsencrypt-prod
          hajimari.io/enable: "true"
          # hajimari.io/icon: "simple-icons:homeassistant"
        ingressClassName: external-nginx
        hosts:
          - host: &host dataflow.${EXTERNAL_DOMAIN}
            paths:
              - path: /
        tls: true
          # - hosts:
              # - *host
            # secretName: dataflow-tls-external

    mariadb:
      enabled: false

    externalDatabase:
      dataflow:
        url: jdbc:postgresql://pg-dataflow-rw:5432/dataflow?password=dnfxVGfWREOa7Ckvf5z7Y6TJfVFaGbMug505AGevaDRL4mVCVBIdMVVJ8ui4thkY&user=dataflow
        database: dataflow
        user: dataflow
      skipper:
        url: jdbc:postgresql://pg-skipper-rw:5432/skipper?password=BuHtV1rVsEjylP56k484dcG8VnKdSY8ISjdHZSLdayEqzajRsfUY3DHRO2NKQcmM&user=skipper
        database: skipper
        user: skipper

    rabbitmq:
      enabled: false

    externalRabbit:
      enabled: true

      host: rabbit-dataflow.dataflow.svc.cluster.local
      port: 5762
      username: default_user_NpuJXrc04TXbFdFbbpH
      existingPasswordSecret: rabbit-dataflow-default-user
