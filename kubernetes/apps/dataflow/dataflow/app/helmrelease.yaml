---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: spring-cloud-dataflow
  namespace: dataflow
spec:
  interval: 30m
  chart:
    spec:
      chart: spring-cloud-dataflow
      version: 25.1.3
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
      interval: 30m

  values:

    server:

      configuration:
        metricsDashboard: grafana.monitor.svc.cluster.local:80

      extraEnvVars:
        - name: SPRING_CONFIG_IMPORT
          value: configtree:/etc/secrets
        # - name: SPRING_DATASOURCE_URL
        #   valueFrom:
        #     secretKeyRef:
        #       name: pg-dataflow-app
        #       key: jdbc-url

      resources:
        limits:
          cpu: "1"
          memory: 1024M
        requests:
          cpu: "1"
          memory: 1024M

      service:
        type: LoadBalancer
        port: 8080

      ingress:
        enabled: true

        annotations:
          nginx.org/websocket-services: dataflow
          cert-manager.io/cluster-issuer: letsencrypt-prod
          hajimari.io/enable: "true"
          # hajimari.io/icon: "simple-icons:"
        ingressClassName: external-nginx
        hostname: &host dataflow.${EXTERNAL_DOMAIN}
        tls: true

      extraVolumes:
        - name: pg-dataflow-app
          secret:
            secretName: pg-dataflow-app

      extraVolumeMounts:
        - name: pg-dataflow-app
          mountPath: /etc/secrets/postgres
          readOnly: true

    skipper:

      extraEnvVars: 
        - name: SPRING_CONFIG_IMPORT
          value: configtree:/etc/secrets
        # - name: SPRING_DATASOURCE_URL
        #   valueFrom:
        #     secretKeyRef:
        #       name: pg-skipper-app
        #       key: jdbc-url
        # - name: SPRING_RABBITMQ_HOST
        #   valueFrom:
        #     secretKeyRef:
        #       name: rabbit-dataflow-default-user
        #       key: host
        # - name: SPRING_RABBITMQ_PORT
        #   valueFrom:
        #     secretKeyRef:
        #       name: rabbit-dataflow-default-user
        #       key: port
        # - name: SPRING_RABBITMQ_USERNAME
        #   valueFrom:
        #     secretKeyRef:
        #       name: rabbit-dataflow-default-user
        #       key: username
        # - name: SPRING_RABBITMQ_PASSWORD
        #   valueFrom:
        #     secretKeyRef:
        #       name: rabbit-dataflow-default-user
        #       key: password

      extraVolumes:
        - name: pg-skipper-app
          secret:
            secretName: pg-skipper-app
        - name: rabbit-dataflow-default-user
          secret:
            secretName: rabbit-dataflow-default-user
        - name: rabbit-dataflow-erlang-cookie
          secret:
            secretName: rabbit-dataflow-erlang-cookie

      extraVolumeMounts:
        - name: pg-skipper-app
          mountPath: /etc/secrets/postgres
          readOnly: true
        - name: rabbit-dataflow-default-user
          mountPath: /etc/secrets/rabbitmqcluster
          readOnly: true
        - name: rabbit-dataflow-erlang-cookie
          mountPath: /etc/secrets/rabbitmqerlang
          readOnly: true

    metrics:
      enabled: true

      resources:
        limits:
          cpu: "100m"
          memory: 128Mi
        requests:
          cpu: "100m"
          memory: 128Mi

      serviceMonitor:
        enabled: true

    mariadb:
      enabled: false

    externalDatabase:
      dataflow:
        username: ${postgres.username}
      skipper:
        username: ${postgres.username}

    rabbitmq:
      enabled: false
      
      auth:
        password: ${rabbitmqcluster.password}
        erlangCookie: ${rabbitmqerlang..erlang.cookie}

    externalRabbitmq:
      enabled: true
      host: ${rabbitmqcluster.host}
      port: ${rabbitmq-luster.port}
      username: ${rabbitmqcluster.username}
      password: ${rabbitmqcluster.password}
