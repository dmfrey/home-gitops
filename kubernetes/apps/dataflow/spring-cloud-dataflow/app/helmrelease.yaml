---
# yaml-language-server: $schema=https://kubernetes-schemas.dmfrey.com/helm.toolkit.fluxcd.io/helmrelease_v2beta2.json
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: spring-cloud-dataflow
  namespace: dataflow
spec:
  interval: 5m
  chart:
    spec:
      chart: spring-cloud-dataflow
      version: 26.8.1
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system

  maxHistory: 2

  install:
    createNamespace: true
    timeout: 1m
    remediation:
      retries: 3

  upgrade:
    cleanupOnFail: true
    timeout: 1m
    remediation:
      retries: 3

  uninstall:
    keepHistory: false

  valuesFrom:
    - kind: Secret
      name: pg-dataflow-app
      valuesKey: jdbc-uri
      targetPath: externalDatabase.dataflow.url
    
    - kind: Secret
      name: pg-skipper-app
      valuesKey: jdbc-uri
      targetPath: externalDatabase.skipper.url

    - kind: Secret
      name: rabbit-dataflow-default-user
      valuesKey: password
      targetPath: rabbit.auth.password
    - kind: Secret
      name: rabbit-dataflow-erlang-cookie
      valuesKey: .erlang.cookie
      targetPath: rabbit.auth.erlangCookie

    - kind: Secret
      name: rabbit-dataflow-default-user
      valuesKey: host
      targetPath: externalRabbit.host
    - kind: Secret
      name: rabbit-dataflow-default-user
      valuesKey: port
      targetPath: externalRabbit.port
    - kind: Secret
      name: rabbit-dataflow-default-user
      valuesKey: username
      targetPath: externalRabbit.username
    - kind: Secret
      name: rabbit-dataflow-default-user
      valuesKey: password
      targetPath: externalRabbit.password

  values:

    server:

      configuration:
        metricsDashboard: https://grafana.dmfrey.com:443

      resources:
        limits:
          cpu: "1"
          memory: 2048M
        requests:
          cpu: "0.5"
          memory: 1024M

      service:
        type: LoadBalancer
        port: 8080

      ingress:
        enabled: true

        annotations:
          nginx.org/websocket-services: dataflow
          cert-manager.io/cluster-issuer: letsencrypt-prod
          hajimari.io/enable: "true"
          # hajimari.io/icon: "simple-icons:"
          external-dns.alpha.kubernetes.io/target: ingress-ext.dmfrey.com
        ingressClassName: nginx-external
        hostname: &host dataflow.${EXTERNAL_DOMAIN}
        tls: true

    metrics:
      enabled: true

      resources:
        limits:
          cpu: "1.0"
          memory: 2048Mi
        requests:
          cpu: "0.5"
          memory: 1024Mi
      
      replicaCount: 3
      
      serviceMonitor:
        enabled: true

    mariadb:
      enabled: false

    externalDatabase:
      enabled: true
      
    rabbitmq:
      enabled: false
      
    externalRabbitmq:
      enabled: true
